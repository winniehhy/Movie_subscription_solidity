<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            width: 70%;
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            background-color: #e5e7eb;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            background-color: #e5e7eb;
            border-radius: 10px 10px 0 0;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #1d4ed8;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .notification-item {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 5px 10px;
            background-color: #1d4ed8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #3b82f6;
        }

        #clearStorageButton {
            margin-top: 20px;
            background-color: #e53e3e;
        }

        .badge {
            background-color: red;
            color: white;
            border-radius: 12px;
            padding: 0 6px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .filter-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filter-section input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 48%;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <div class="tab active" id="new-tab" onclick="showTab('new-notifications', 'new-tab')">
            New Notifications <span id="notificationCount" class="badge"></span>
        </div>
        <div class="tab" id="history-tab" onclick="showTab('notification-history', 'history-tab')">Notification History</div>
    </div>

    <div class="tab-content active" id="new-notifications">
        <div class="filter-section">
            <input type="text" id="searchInput" placeholder="Search notifications..." oninput="filterNotifications()">
            <input type="date" id="dateFilter" onchange="filterNotifications()">
        </div>
        <div id="newNotifications" class="panel">
            <!-- New notifications will appear here -->
        </div>
    </div>

    <div class="tab-content" id="notification-history">
        <div class="filter-section">
            <input type="text" id="searchHistoryInput" placeholder="Search notification history..." oninput="filterHistoryNotifications()">
            <input type="date" id="dateFilterHistory" onchange="filterHistoryNotifications()">
        </div>
        <div id="notificationHistory" class="panel">
            <!-- Notification history will appear here -->
        </div>
    </div>

    <button id="clearStorageButton" class="btn">Clear All Data</button>
    <button id="disconnectButton" class="btn">Disconnect Wallet</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let userAddress = null;

    async function initialize() {
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];

            if (userAddress) {
                loadNotifications();
                loadNotificationHistory();
            } else {
                alert('Please connect your wallet!');
                window.location.href = 'index.html';
            }
        } else {
            alert('Please install MetaMask!');
            window.location.href = 'index.html';
        }
    }

    const userNotificationsKey = () => `notifications_${userAddress}`;
    const userReadNotificationsKey = () => `readNotifications_${userAddress}`;

    async function loadNotifications() {
        const newNotifications = document.getElementById('newNotifications');
        const notifications = JSON.parse(localStorage.getItem(userNotificationsKey())) || [];
        
        const notificationCount = document.getElementById('notificationCount');
        notificationCount.textContent = notifications.length > 0 ? notifications.length : '';

        newNotifications.innerHTML = '';

        if (notifications.length === 0) {
            newNotifications.innerHTML = '<p>No new notifications.</p>';
            return;
        }

        notifications.forEach((notification, index) => {
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item';
            notificationItem.innerHTML = `                
                <p>${notification.message} <small>${new Date(notification.timestamp).toLocaleString()}</small></p>
                <button class="btn" onclick="markAsRead(${index})">Mark as Read</button>
            `;
            newNotifications.appendChild(notificationItem);
        });
    }

    async function loadNotificationHistory() {
        const notificationHistory = document.getElementById('notificationHistory');
        const readNotifications = JSON.parse(localStorage.getItem(userReadNotificationsKey())) || [];

        notificationHistory.innerHTML = '';

        if (readNotifications.length === 0) {
            notificationHistory.innerHTML = '<p>No notification history.</p>';
            return;
        }

        readNotifications.forEach(notification => {
            const historyItem = document.createElement('div');
            historyItem.className = 'notification-item';
            historyItem.innerHTML = `
                <p>${notification.message} <small>${new Date(notification.timestamp).toLocaleString()}</small></p>
            `;
            notificationHistory.appendChild(historyItem);
        });
    }

    function markAsRead(index) {
        const notifications = JSON.parse(localStorage.getItem(userNotificationsKey())) || [];
        const [readNotification] = notifications.splice(index, 1);
        localStorage.setItem(userNotificationsKey(), JSON.stringify(notifications));

        const readNotifications = JSON.parse(localStorage.getItem(userReadNotificationsKey())) || [];
        readNotifications.push(readNotification);
        localStorage.setItem(userReadNotificationsKey(), JSON.stringify(readNotifications));

        loadNotifications();
        loadNotificationHistory();
    }

    function filterNotifications() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const selectedDate = document.getElementById('dateFilter').value;
        const notifications = JSON.parse(localStorage.getItem(userNotificationsKey())) || [];
        const newNotificationsDiv = document.getElementById('newNotifications');

        newNotificationsDiv.innerHTML = '';

        const filteredNotifications = notifications.filter(notification => {
            const notificationDate = new Date(notification.timestamp).toISOString().split('T')[0];
            const matchesSearch = notification.message.toLowerCase().includes(searchValue);
            const matchesDate = selectedDate ? notificationDate === selectedDate : true;
            return matchesSearch && matchesDate;
        });

        if (filteredNotifications.length === 0) {
            newNotificationsDiv.innerHTML = '<p>No matching notifications.</p>';
            return;
        }

        filteredNotifications.forEach((notification, index) => {
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item';
            notificationItem.innerHTML = `                
                <p>${notification.message} <small>${new Date(notification.timestamp).toLocaleString()}</small></p>
                <button class="btn" onclick="markAsRead(${index})">Mark as Read</button>
            `;
            newNotificationsDiv.appendChild(notificationItem);
        });
    }

    function filterHistoryNotifications() {
        const searchValue = document.getElementById('searchHistoryInput').value.toLowerCase();
        const selectedDate = document.getElementById('dateFilterHistory').value;
        const readNotifications = JSON.parse(localStorage.getItem(userReadNotificationsKey())) || [];
        const notificationHistoryDiv = document.getElementById('notificationHistory');

        notificationHistoryDiv.innerHTML = '';

        const filteredHistory = readNotifications.filter(notification => {
            const notificationDate = new Date(notification.timestamp).toISOString().split('T')[0];
            const matchesSearch = notification.message.toLowerCase().includes(searchValue);
            const matchesDate = selectedDate ? notificationDate === selectedDate : true;
            return matchesSearch && matchesDate;
        });

        if (filteredHistory.length === 0) {
            notificationHistoryDiv.innerHTML = '<p>No matching notification history.</p>';
            return;
        }

        filteredHistory.forEach(notification => {
            const historyItem = document.createElement('div');
            historyItem.className = 'notification-item';
            historyItem.innerHTML = `
                <p>${notification.message} <small>${new Date(notification.timestamp).toLocaleString()}</small></p>
            `;
            notificationHistoryDiv.appendChild(historyItem);
        });
    }

    function showTab(tabId, activeTabId) {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => tab.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        document.getElementById(activeTabId).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    document.getElementById('clearStorageButton').onclick = function() {
        localStorage.removeItem(userNotificationsKey());
        localStorage.removeItem(userReadNotificationsKey());
        loadNotifications();
        loadNotificationHistory();
        alert('All notification data cleared.');
    };

    document.getElementById('disconnectButton').onclick = function() {
        userAddress = null;
        document.getElementById('newNotifications').innerHTML = '<p>No new notifications.</p>';
        document.getElementById('notificationHistory').innerHTML = '<p>No notification history.</p>';
        document.getElementById('notificationCount').textContent = '';
        localStorage.removeItem(userNotificationsKey());
        localStorage.removeItem(userReadNotificationsKey());
        alert('Wallet disconnected. Notifications cleared.');
    };

    function addSubscription(subscriptionId, startDate, durationInDays) {
    const subscriptions = JSON.parse(localStorage.getItem(`subscriptions_${userAddress}`)) || [];
    const endDate = new Date(startDate).getTime() + durationInDays * 60 * 1000; // Treat each "day" as 1 minute
    
    const subscription = {
        id: subscriptionId,
        startDate: startDate,
        endDate: endDate,
        alerted: false // Flag to track if the user has been alerted
    };

    subscriptions.push(subscription);
    localStorage.setItem(`subscriptions_${userAddress}`, JSON.stringify(subscriptions));
}

function checkForExpiringSubscriptions() {
    console.log("Checking for expiring subscriptions...");
    const subscriptions = JSON.parse(localStorage.getItem(`subscriptions_${userAddress}`)) || [];
    const currentTime = Date.now();

    subscriptions.forEach(subscription => {
        const minutesLeft = Math.floor((subscription.endDate - currentTime) / (1000 * 60)); // Calculate minutes left until expiration
        console.log(`Subscription ID: ${subscription.id}, Minutes left: ${minutesLeft}, Alerted: ${subscription.alerted}`);

        if (minutesLeft === 3 || minutesLeft === 2 || minutesLeft === 1) {
            if (!subscription.alerted) {
                addNotification(`Your subscription (ID: ${subscription.id}) will expire in ${minutesLeft} minute(s).`);
                subscription.alerted = true;
            }
        }

        if (currentTime >= subscription.endDate && subscription.alerted !== 'expired') {
            addNotification(`Your subscription (ID: ${subscription.id}) has expired.`);
            subscription.alerted = 'expired';
        }
    });

    localStorage.setItem(`subscriptions_${userAddress}`, JSON.stringify(subscriptions));
    loadNotifications(); // Refresh the notification list
}



    function addNotification(message) {
        const notifications = JSON.parse(localStorage.getItem(userNotificationsKey())) || [];
        const newNotification = {
            message: message,
            timestamp: Date.now()
        };
        notifications.push(newNotification);
        localStorage.setItem(userNotificationsKey(), JSON.stringify(notifications));
        loadNotifications();

        const notificationCount = document.getElementById('notificationCount');
        notificationCount.textContent = notifications.length > 0 ? notifications.length : '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        initialize();

        setInterval(() => {
            checkForExpiringSubscriptions();
        }, 5000);
    });
</script>

</body>
</html>
